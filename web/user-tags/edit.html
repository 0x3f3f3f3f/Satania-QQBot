<!doctype html>
<html lang="zh-CN">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <title>Satania标签自助系统</title>
</head>

<body style="background-color: #f5f5f5;padding-top: 40px; padding-bottom: 40px;">
    <div class="container">
        <div class="accordion" id="userTagList">
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- 萨塔妮娅API -->
    <script src="js/satania.api.js"></script>

    <script>
        function addCard(parent, userTag) {
            let type;
            switch (userTag.type) {
                case 'regexp':
                    type = '正则';
                    break;
                case 'string':
                    type = '简单';
                    break;
                default:
                    type = '未知'
                    break;
            }

            const card = $(
                '<div class="card">' +
                '<div class="card-header p-2">' +
                `<div class="row collapsed" id="heading${userTag.id}" data-toggle="collapse" data-target="#collapse${userTag.id}" aria-expanded="false" aria-controls="collapse${userTag.id}">` +
                '<div class="col-6 text-truncate">' +
                `#${userTag.id} ` +
                `<span class="badge badge-primary mr-1">${type}</span>` +
                (userTag.editable ? '<span class="badge badge-success mr-1">可编辑</span>' : '') +
                (userTag.type == 'string' ? userTag.match.split(',').join(' ') : userTag.match) +
                '</div>' +
                `<div class="col text-truncate font-italic text-muted">//${userTag.comment}</div>` +
                `<div class="col-1"><span class="badge badge-secondary float-right mt-1">${userTag.userName}</span></div>` +
                '</div>' +
                '</div>' +
                `<div id="collapse${userTag.id}" class="collapse" aria-labelledby="heading${userTag.id}" data-parent="#${parent.attr('id')}">` +
                '<div class="card-body"></div>' +
                '</div>' +
                '</div>'
            );

            const body = $(
                '<div class="row mb-4">' +
                '<div class="col">' +
                '<p class="mb-1">匹配规则</p>' +
                '<div id="matchButtons"></div>' +
                `<input type="text" class="form-control" id="matchInput" value="${userTag.match}">` +
                '</div>' +
                '<div class="col-4 text-right">' +
                '<p class="mb-1">匹配类型</p>' +
                '<button class="btn btn-info dropdown-toggle" type="button" id="matchTypeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                type + '</button>' +
                '<div class="dropdown-menu dropdown-menu-right" aria-labelledby="matchTypeButton">' +
                '<button class="dropdown-item" type="button" id="string">简单</button>' +
                '<button class="dropdown-item" type="button" id="regexp">正则</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="row mb-4">' +
                '<div class="col">' +
                '<p class="mb-1">对应标签</p>' +
                '<div id="rawTagButtons"></div>' +
                '</div>' +
                '</div>' +
                '<div class="row mb-4">' +
                '<div class="col">' +
                '<p class="mb-1">注释</p>' +
                '<div class="input-group">' +
                '<div class="input-group-prepend">' +
                '<span class="input-group-text">//</span>' +
                '</div>' +
                `<input type="text" class="form-control" id='commentInput' value="${userTag.comment}">` +
                '</div>' +
                '</div>' +
                '</div>'
            );

            const matchButtons = body.find('#matchButtons');
            const matchInput = body.find('#matchInput');
            matchInput.blur(() => {
                matchInput.val(matchInput.val().replace(/,/g, ''));
            });
            if (userTag.type == 'string') {
                matchInput.hide();
                if (userTag.match != '') {
                    const keywords = userTag.match.split(',');
                    if (userTag.editable) {
                        for (let i = 0; i < keywords.length; i++) {
                            const keyword = keywords[i];
                            const btn = addMatchButton(keyword);
                            matchButtons.append(btn);
                        }
                    } else {
                        for (let i = 0; i < keywords.length; i++) {
                            const keyword = keywords[i];
                            matchButtons.append(
                                `<label class="alert alert-info px-2 py-1 mr-1 mb-1">${keyword}</label>`
                            );
                        }
                    }
                }
            } else {
                matchButtons.hide();
            }

            const rawTagButtons = body.find('#rawTagButtons');
            if (userTag.rawTags != '') {
                const rawTags = userTag.rawTags.split(',');
                if (userTag.editable) {
                    for (let i = 0; i < rawTags.length; i++) {
                        const tag = rawTags[i];
                        const btn = addRawTagButton(tag);
                        rawTagButtons.append(btn);
                    }
                } else {
                    for (let i = 0; i < rawTags.length; i++) {
                        const tag = rawTags[i];
                        switch (tag) {
                            case '|':
                                rawTagButtons.append(
                                    '<label class="alert alert-light px-1 py-1 mr-1 mb-1">或</label>'
                                );
                                break;
                            case '&':
                                rawTagButtons.append(
                                    '<label class="alert alert-light px-1 py-1 mr-1 mb-1">与</label>'
                                );
                                break;
                            default:
                                rawTagButtons.append(
                                    '<label class="alert alert-info px-2 py-1 mr-1 mb-1">${tag}</label>'
                                );
                                break;
                        }
                    }
                }
            }

            card.find('.card-body').append(body);

            if (userTag.editable) {
                const btn1 = $('<button type="button" class="btn btn-outline-info mb-1">新增...</button>');
                btn1.click(addMatch);
                matchButtons.append(btn1);
                const btn2 = $('<button type="button" class="btn btn-outline-info mb-1">新增...</button>');
                btn2.click(addRawTag);
                rawTagButtons.append(btn2);
                const btn3 = $('<div class="row">' +
                    '<div class="col text-right">' +
                    '<button type="button" class="btn btn-primary w-25">提交</button>' +
                    '</div>' +
                    '</div>');
                btn3.click({
                    id: userTag.id,
                    card
                }, submitUserTag);
                body.parent().append(btn3);

                const matchTypeButton = body.find('#matchTypeButton');
                const dropdownMenu = body.find('.dropdown-menu[aria-labelledby="matchTypeButton"]');
                dropdownMenu.find('#string').click({
                    type: 'string',
                    matchTypeButton,
                    matchButtons,
                    matchInput
                }, changeTagType);
                dropdownMenu.find('#regexp').click({
                    type: 'regexp',
                    matchTypeButton,
                    matchButtons,
                    matchInput
                }, changeTagType);
            } else {
                matchInput.attr('disabled', true);
                body.find('#matchTypeButton').attr('disabled', true);
                body.find('#commentInput').attr('disabled', true);
            }

            parent.append(card);
            return card;
        }

        function updateUserTagsList(userTags) {
            const userTagList = $('#userTagList');
            userTagList.empty();
            for (const userTag of userTags) {
                addCard(userTagList, userTag);
            }
            const card = addCard(userTagList, {
                id: 'Add',
                userName: '',
                type: 'string',
                match: '',
                rawTags: '',
                comment: '',
                editable: true
            });
            const cardHeading = card.find('#headingAdd');
            cardHeading.empty();
            cardHeading.append(
                '<div class="col text-truncate text-right">' +
                '<button type="button" class="btn btn-primary btn-sm">新增...</button>' +
                '</div>'
            );
        }

        function addMatchButton(keyword) {
            const btn = $(
                `<button type="button" class="btn btn-info mr-1 mb-1">${keyword}</button>`
            );
            btn.click(editMatch);
            return btn;
        }

        function addRawTagButton(tag) {
            let btn;
            switch (tag) {
                case '|':
                    btn = $(
                        '<button type="button" class="btn btn-light px-2 mr-1 mb-1" operator="|">或</button>'
                    );
                    btn.click(changeTagOperator);
                    break;
                case '&':
                    btn = $(
                        '<button type="button" class="btn btn-light px-2 mr-1 mb-1" operator="&">与</button>'
                    );
                    btn.click(changeTagOperator);
                    break;
                default:
                    btn = $(
                        `<button type="button" class="btn btn-info mr-1 mb-1">${tag}</button>`
                    );
                    btn.click(editRawTag);
                    break;
            }
            return btn;
        }

        function changeTagType(event) {
            switch (event.data.type) {
                case 'string':
                    event.data.matchTypeButton.text('简单');
                    event.data.matchButtons.show();
                    event.data.matchInput.hide();
                    break;
                case 'regexp':
                    event.data.matchTypeButton.text('正则');
                    event.data.matchButtons.hide()
                    event.data.matchInput.show();
                    break;
            }
        }

        function addMatch() {
            const btn = $(this);
            btn.hide();
            const input = $(`<input type="text" class="w-50 form-control">`);
            const div = $('<div class="col-4"></div>');
            div.append(input);
            div.insertBefore(btn);
            input.focus();
            input.blur(() => {
                input.val(input.val().replace(/,/g, ''));
                if (/^\s*$/.test(input.val())) {
                    div.remove();
                    btn.show();
                } else {
                    const btnNew = addMatchButton(input.val());
                    btnNew.insertBefore(btn);
                    div.remove();
                    btn.show();
                }
            });
        }

        function editMatch() {
            const btn = $(this);
            const keyword = btn.text();
            btn.hide();
            const input = $(`<input type="text" form-control" value="${keyword}">`);
            const div = $('<div class="col-4"></div>');
            div.append(input);
            div.insertBefore(btn);
            input.focus();
            input.blur(() => {
                input.val(input.val().replace(/,/g, ''));
                if (/^\s*$/.test(input.val())) {
                    div.remove();
                    btn.remove();
                } else {
                    btn.text(input.val());
                    div.remove();
                    btn.show();
                }
            });
        }

        function addRawTag() {
            const btn = $(this);
            btn.hide();
            const input = $(`<input type="text" class="w-50 form-control">`);
            const div = $('<div class="col-4"></div>');
            div.append(input);
            div.insertBefore(btn);
            input.focus();
            input.blur(() => {
                input.val(input.val().replace(/,/g, ''));
                if (/^\s*$/.test(input.val())) {
                    div.remove();
                    btn.show();
                } else {
                    const operatorNew = addRawTagButton('|');
                    operatorNew.insertBefore(btn);
                    const btnNew = addRawTagButton(input.val());
                    btnNew.insertBefore(btn);
                    div.remove();
                    btn.show();
                }
            });
        }

        function editRawTag() {
            const btn = $(this);
            const tag = btn.text();
            btn.hide();
            const input = $(`<input type="text" class="w-50 form-control" value="${tag}">`);
            const div = $('<div class="col-4"></div>');
            div.append(input);
            div.insertBefore(btn);
            input.focus();
            input.blur(() => {
                input.val(input.val().replace(/,/g, ''));
                if (/^\s*$/.test(input.val())) {
                    div.remove();
                    btn.prev().remove();
                    btn.remove();
                } else {
                    btn.text(input.val());
                    div.remove();
                    btn.show();
                }
            });
        }

        function changeTagOperator() {
            const btn = $(this);
            switch (btn.attr('operator')) {
                case '|':
                    btn.attr('operator', '&');
                    btn.text('与');
                    break;
                case '&':
                    btn.attr('operator', '|');
                    btn.text('或');
                    break;
            }
        }

        function submitUserTag(event) {
            console.log(event.data.id);
        }
    </script>

    <script>
        const searchParams = new URLSearchParams(window.location.search);

        $(document).ready(async () => {
            // 获得用户标签
            let response = await SataniaAPI.getUserTags(searchParams.get('key'));
            updateUserTagsList(response.userTags);
        });
    </script>
</body>