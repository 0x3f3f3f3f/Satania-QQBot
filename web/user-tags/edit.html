<!doctype html>
<html lang="zh-CN">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <title>Satania标签自助系统</title>
</head>

<body style="background-color: #f5f5f5;padding-top: 40px; padding-bottom: 40px;">
    <div class="container">
        <div class="accordion" id="userTagList">
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- 萨塔妮娅API -->
    <script src="js/satania.api.js"></script>

    <script>
        function createCard(parent, userTag) {
            let type;
            switch (userTag.type) {
                case 'regexp':
                    type = '正则';
                    break;
                case 'string':
                    type = '简单';
                    break;
                default:
                    type = '未知'
                    break;
            }

            const card = $(
                '<div class="card">' +
                '<div class="card-header p-2">' +
                `<div class="row collapsed" id="heading${userTag.id}" data-toggle="collapse" data-target="#collapse${userTag.id}" aria-expanded="false" aria-controls="collapse${userTag.id}">` +
                '<div class="col-6 text-truncate">' +
                `#${userTag.id} ` +
                `<span class="badge badge-primary mr-1">${type}</span>` +
                (userTag.editable ? '<span class="badge badge-success mr-1">可编辑</span>' : '') +
                (userTag.type == 'string' ? userTag.match.split(',').join(' ') : userTag.match) +
                '</div>' +
                `<div class="col text-truncate font-italic" style="color:lightgray;">//${userTag.comment}</div>` +
                `<div class="col-1"><span class="badge badge-secondary float-right mt-1">${userTag.userName}</span></div>` +
                '</div>' +
                '</div>' +
                `<div id="collapse${userTag.id}" class="collapse" aria-labelledby="heading${userTag.id}" data-parent="#${parent.attr('id')}">` +
                '<div class="card-body"></div>' +
                '</div>' +
                '</div>'
            );

            const body = $(
                '<div class="row">' +
                '<div class="col">' +
                '<label>匹配规则</label><br>' +
                '<div id="matchButtons"></div>' +
                `<input type="text" class="form-control" id="matchInput" value="${userTag.match}">` +
                '</div>' +
                '<div class="col-4">' +
                '<label>匹配类型</label><br>' +
                '<button class="btn btn-info dropdown-toggle" type="button" id="matchTypeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                type + '</button>' +
                '<div class="dropdown-menu" aria-labelledby="matchTypeButton">' +
                '<button class="dropdown-item" id="string">简单</button>' +
                '<button class="dropdown-item" id="regexp">正则</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<br>' +
                '<div class="row">' +
                '<div class="col">' +
                '<label>对应标签</label><br>' +
                '<div id="rawTagButtons"></div>' +
                '</div>' +
                '</div>' +
                '<br>' +
                '<div class="row">' +
                '<div class="col">' +
                '<label>注释</label><br>' +
                '<div class="input-group">' +
                '<div class="input-group-prepend">' +
                '<span class="input-group-text">//</span>' +
                '</div>' +
                `<input type="text" class="form-control" id='commentInput' value="${userTag.comment}">` +
                '</div>' +
                '</div>' +
                '</div>' +
                '<br>' +
                '<div class="row">' +
                '<div class="col text-right">' +
                '<button type="button" class="btn btn-primary w-25" id="submitButton">提交</button>' +
                '</div>' +
                '</div>'
            );

            const matchButtons = body.find('#matchButtons');
            if (userTag.type == 'string' & userTag.match != '') {
                const keywords = userTag.match.split(',');
                body.find('#matchInput').hide();
                for (let i = 0; i < keywords.length; i++) {
                    const keyword = keywords[i];
                    matchButtons.append(
                        `<button type="button" class="btn btn-outline-info mr-1 mb-1" id="matchButton${i}">${keyword}</button>`
                    );
                }
            } else {
                body.find('#matchButtons').hide();
            }
            matchButtons.append(
                '<button type="button" class="btn btn-info mb-1" id="matchAddButton">新增...</button>');

            const rawTagButtons = body.find('#rawTagButtons');
            if (userTag.rawTags != '') {
                const rawTags = userTag.rawTags.split(',');
                for (let i = 0; i < rawTags.length; i++) {
                    const tag = rawTags[i];
                    if (tag == '|' || tag == '&') {
                        switch (tag) {
                            case '|':
                                rawTagButtons.append(
                                    `<button type="button" class="btn btn-light px-2 mr-1 mb-1 text-decoration-none" id="rawTagButton${i}">OR</button>`
                                );
                                break;
                            case '&':
                                rawTagButtons.append(
                                    `<button type="button" class="btn btn-light px-2 mr-1 mb-1 text-decoration-none" id="rawTagButton${i}">AND</button>`
                                );
                                break;
                        }
                    } else {
                        rawTagButtons.append(
                            `<button type="button" class="btn btn-outline-info mr-1 mb-1" id="rawTagButton${i}">${tag}</button>`
                        );
                    }
                }
            }
            rawTagButtons.append(
                '<button type="button" class="btn btn-info mb-1" id="rawTagAddButton">新增...</button>');

            card.find('.card-body').append(body);
            parent.append(card);
            return card;
        }

        function updateUserTagsList(userTags) {
            const userTagList = $('#userTagList');
            userTagList.empty();
            for (const userTag of userTags) {
                createCard(userTagList, userTag);
            }
            const addCard = createCard(userTagList, {
                id: 'Add',
                userName: '',
                type: 'string',
                match: '',
                rawTags: '',
                comment: ''
            });
            const addCardHeading = addCard.find('#headingAdd');
            addCardHeading.empty();
            addCardHeading.append(
                '<div class="col text-truncate text-right">' +
                '<button type="button" class="btn btn-primary btn-sm">新增...</button>' +
                '</div>'
            );
        }
    </script>

    <script>
        const searchParams = new URLSearchParams(window.location.search);

        $(document).ready(async () => {
            // 获得用户标签
            let response = await SataniaAPI.getUserTags(searchParams.get('key'));
            updateUserTagsList(response.userTags);
        });
    </script>
</body>